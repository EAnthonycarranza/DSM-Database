<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF Editor & Signer</title>

    <!-- Google Fonts for Signature Styles -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Great+Vibes&family=Pacifico&family=Satisfy&family=Dancing+Script:wght@400;600&family=Caveat:wght@500;700&family=Allura&display=swap" rel="stylesheet" />

    <!-- Font Awesome 6 (icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root{
            --primary:#4f46e5;
            --primary-dark:#4338ca;
            --secondary:#06b6d4;
            --success:#10b981;
            --danger:#ef4444;
            --warning:#f59e0b;
            --dark:#1e293b;
            --light:#f1f5f9;
            --border:#e2e8f0;
            --shadow:0 10px 25px rgba(0,0,0,.1);
            --shadow-lg:0 20px 40px rgba(0,0,0,.15);
        }

        body{
            font-family:'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh; color:var(--dark);
        }

        /* Header */
        .header{
            background:#fff; padding:1rem 2rem; box-shadow:var(--shadow);
            display:flex; align-items:center; justify-content:space-between;
            position:sticky; top:0; z-index:100;
        }
        .brand{ display:flex; align-items:center; gap:.75rem; font-size:1.25rem; font-weight:600; color:var(--primary); }
        .brand i{ font-size:1.5rem; }

        .nav-controls{ display:flex; align-items:center; gap:1rem; }

        .mode-switch{ display:flex; background:var(--light); border-radius:8px; padding:4px; }
        .mode-switch button{
            padding:.5rem 1rem; border:none; background:transparent; border-radius:6px;
            cursor:pointer; font-weight:500; transition:all .3s;
        }
        .mode-switch button.active{
            background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.1); color:var(--primary);
        }

        /* Layout */
        .main-layout{ display:flex; height:calc(100vh - 72px); background:#fff; }
        .sidebar{
            width:280px; background:var(--light); border-right:1px solid var(--border);
            padding:1.5rem; overflow-y:auto;
        }
        .sidebar.right{ border-right:none; border-left:1px solid var(--border); }
        .sidebar h3{
            font-size:.875rem; text-transform:uppercase; letter-spacing:.05em;
            color:#64748b; margin-bottom:1rem;
        }
        .viewer{ flex:1; background:#f8fafc; overflow:auto; position:relative; }
        .pages-container{ padding:2rem; display:flex; flex-direction:column; align-items:center; gap:2rem; }
        .page-wrapper{ position:relative; background:#fff; box-shadow:var(--shadow-lg); border-radius:8px; overflow:hidden; }
        .page-canvas{ display:block; }
        .overlay{ position:absolute; inset:0; pointer-events:auto; }

        /* Fields */
        .field{
            position:absolute; border:2px dashed var(--primary);
            background:rgba(79,70,229,.05); border-radius:4px; cursor:move;
            display:flex; align-items:center; justify-content:center; transition:all .2s; user-select:none;
        }
        .field:hover{ background:rgba(79,70,229,.1); border-color:var(--primary-dark); }
        .field.signature{ border-color:var(--secondary); background:rgba(6,182,212,.05); }
        .field.date{ border-color:var(--warning); background:rgba(245,158,11,.05); }
        .field.text{ border-color:var(--success); background:rgba(16,185,129,.05); }
        .field-label{ font-size:.875rem; font-weight:500; color:var(--dark); pointer-events:none; }

        .field.filled{ border-style:solid; background:#fff; }
        .field.filled img{ max-width:100%; max-height:100%; object-fit:contain; }
        .field.filled .signature-text{
            width:100%; height:100%; display:flex; align-items:center; justify-content:center; overflow:hidden;
        }
        .signature-fit { white-space: nowrap; }

        .resize-handle{
            position:absolute; bottom:0; right:0; width:18px; height:18px;
            background:var(--primary); cursor:nwse-resize; border-top-left-radius:4px; border-bottom-right-radius:4px;
            display:flex; align-items:center; justify-content:center; opacity:0; transition:opacity .2s;
        }
        .resize-handle i{ font-size:10px; color:#fff; }
        .field:hover .resize-handle{ opacity:1; }

        .delete-btn{
            position:absolute; top:-8px; right:-8px; width:22px; height:22px;
            background:var(--danger); color:#fff; border-radius:50%;
            display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:12px;
            opacity:0; transition:opacity .2s;
        }
        .delete-btn i{ pointer-events:none; }
        .field:hover .delete-btn{ opacity:1; }

        /* Tools */
        .tool-btn{
            width:100%; padding:.75rem; border:2px solid var(--border); background:#fff; border-radius:8px;
            cursor:pointer; display:flex; align-items:center; gap:.75rem; font-weight:500; transition:all .2s; margin-bottom:.5rem;
        }
        .tool-btn:hover{ border-color:var(--primary); background:rgba(79,70,229,.05); }
        .tool-btn.active{ border-color:var(--primary); background:var(--primary); color:#fff; }
        .tool-btn i{ width:20px; text-align:center; }

        /* Buttons */
        .btn{
            padding:.5rem 1rem; border:none; border-radius:6px; font-weight:500; cursor:pointer; transition:all .2s;
            display:inline-flex; align-items:center; gap:.5rem;
        }
        .btn-primary{ background:var(--primary); color:#fff; }
        .btn-primary:hover{ background:var(--primary-dark); }
        .btn-secondary{ background:var(--light); color:var(--dark); }
        .btn-secondary:hover{ background:var(--border); }
        .btn-success{ background:var(--success); color:#fff; }
        .btn-danger{ background:var(--danger); color:#fff; }
        .btn:disabled{ opacity:.5; cursor:not-allowed; }

        /* File Input */
        .file-input-wrapper{ position:relative; overflow:hidden; display:inline-block; }
        .file-input-wrapper input[type=file]{ position:absolute; left:-9999px; }
        .file-input-label{
            padding:.5rem 1rem; background:var(--primary); color:#fff; border-radius:6px; cursor:pointer;
            display:inline-flex; align-items:center; gap:.5rem; font-weight:500; transition:all .2s;
        }
        .file-input-label:hover{ background:var(--primary-dark); }

        /* Modal */
        .modal{
            position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center;
            z-index:1000; opacity:0; visibility:hidden; transition:all .3s;
        }
        .modal.active{ opacity:1; visibility:visible; }
        .modal-content{
            background:#fff; border-radius:12px; width:90%; max-width:800px; max-height:90vh; overflow:auto;
            transform:scale(.9); transition:transform .3s;
        }
        .modal.active .modal-content{ transform:scale(1); }
        .modal-header{
            padding:1.5rem; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between;
        }
        .modal-header h2{ font-size:1.5rem; color:var(--dark); }
        .modal-close{
            width:32px; height:32px; border-radius:50%; border:none; background:var(--light); cursor:pointer;
            display:flex; align-items:center; justify-content:center; transition:all .2s;
        }
        .modal-close:hover{ background:var(--border); }

        .modal-body{ padding:1.5rem; }
        .modal-footer{ padding:1.5rem; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:.5rem; }

        /* Signature Modal */
        .signature-tabs{ display:flex; gap:.5rem; margin-bottom:1.5rem; border-bottom:2px solid var(--border); }
        .signature-tab{
            padding:.75rem 1.5rem; background:none; border:none; cursor:pointer; font-weight:500; color:#64748b;
            position:relative; transition:all .2s;
        }
        .signature-tab.active{ color:var(--primary); }
        .signature-tab.active::after{ content:''; position:absolute; bottom:-2px; left:0; right:0; height:2px; background:var(--primary); }

        .tab-content{ display:none; }
        .tab-content.active{ display:block; }

        .signature-styles{ display:grid; gap:1rem; }
        .signature-style{
            position:relative; padding:1rem; border:2px solid var(--border); border-radius:8px; cursor:pointer;
            transition:all .2s; display:flex; align-items:center; gap:1rem;
        }
        .signature-style:hover{ border-color:var(--primary); background:rgba(79,70,229,.05); }
        .signature-style.selected{ border-color:var(--primary); background:rgba(79,70,229,.1); }
        .signature-style .selected-check{
            position:absolute; top:.5rem; right:.5rem; width:24px; height:24px; background:var(--primary); color:#fff;
            border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px;
        }
        .signature-preview{ font-size:2rem; line-height:1; }

        .drawing-canvas{ border:2px solid var(--border); border-radius:8px; cursor:crosshair; touch-action:none; background:#fff; }

        /* Utility */
        .hidden{ display:none !important; }
        .user-mode .admin-only{ display:none !important; }
        .admin-mode .user-only{ display:none !important; }

        /* Status List */
        .status-list{ display:flex; flex-direction:column; gap:.5rem; }
        .status-item{
            padding:.75rem; background:#fff; border:1px solid var(--border); border-radius:8px;
            display:flex; align-items:center; justify-content:space-between;
        }
        .status-item.filled{ background:rgba(16,185,129,.1); border-color:var(--success); }
        .status-label{ font-weight:500; }
        .status-icon{ color:var(--success); }

        /* Zoom */
        .zoom-control{
            display:flex; align-items:center; gap:.5rem; margin-top:1rem; padding-top:1rem; border-top:1px solid var(--border);
        }
        .zoom-slider{ flex:1; }
        .zoom-value{ font-weight:500; min-width:50px; text-align:right; }

        /* Toast */
        .toast{
            position:fixed; bottom:2rem; left:50%; transform:translateX(-50%) translateY(100px);
            background:var(--dark); color:#fff; padding:1rem 1.5rem; border-radius:8px; box-shadow:var(--shadow-lg);
            opacity:0; transition:all .3s; z-index:2000;
        }
        .toast.show{ transform:translateX(-50%) translateY(0); opacity:1; }
    </style>
</head>
<body class="admin-mode">
    <header class="header">
        <div class="brand">
            <i class="fa-solid fa-file-signature"></i>
            <span>PDF Editor & Signer</span>
        </div>

        <div class="nav-controls">
            <div class="file-input-wrapper">
                <input type="file" id="pdfInput" accept="application/pdf" />
                <label for="pdfInput" class="file-input-label">
                    <i class="fa-solid fa-upload"></i>
                    Upload PDF
                </label>
            </div>

            <button class="btn btn-secondary" onclick="loadDemo()">
                <i class="fa-solid fa-file-lines"></i>
                Load Demo
            </button>

            <div class="mode-switch">
                <button id="adminMode" class="active" onclick="setMode('admin')">Admin</button>
                <button id="userMode" onclick="setMode('user')">User</button>
            </div>

            <button class="btn btn-primary admin-only" onclick="saveTemplate()" disabled id="saveBtn">
                <i class="fa-solid fa-floppy-disk"></i>
                Save Template
            </button>

            <button class="btn btn-primary user-only" onclick="openSignatureModal()">
                <i class="fa-solid fa-pen-nib"></i>
                Adopt Signature
            </button>

            <button class="btn btn-success user-only" onclick="downloadPDF()" disabled id="downloadBtn">
                <i class="fa-solid fa-download"></i>
                Download Signed
            </button>
        </div>
    </header>

    <main class="main-layout">
        <aside class="sidebar admin-only">
            <h3>Field Tools</h3>

            <button class="tool-btn" data-tool="signature" onclick="selectTool('signature')">
                <i class="fa-solid fa-signature"></i>
                Signature
            </button>

            <button class="tool-btn" data-tool="initials" onclick="selectTool('initials')">
                <i class="fa-solid fa-user-check"></i>
                Initials
            </button>

            <button class="tool-btn" data-tool="date" onclick="selectTool('date')">
                <i class="fa-solid fa-calendar-days"></i>
                Date
            </button>

            <button class="tool-btn" data-tool="text" onclick="selectTool('text')">
                <i class="fa-solid fa-font"></i>
                Text Field
            </button>

            <div style="margin-top:1rem; padding:1rem; background:#fff; border-radius:8px;">
                <p style="font-size:.875rem; color:#64748b; line-height:1.5;">
                    <strong>Instructions:</strong><br />
                    1. Select a tool above<br />
                    2. Click on the PDF to place field<br />
                    3. Drag to move, resize from corner<br />
                    4. Click <i class="fa-solid fa-xmark" style="color:#ef4444;"></i> to delete field
                </p>
            </div>

            <div class="zoom-control">
                <label style="font-size:.875rem;">Zoom:</label>
                <input type="range" id="zoomSlider" class="zoom-slider" min="50" max="200" value="100" oninput="setZoom(this.value)" />
                <span class="zoom-value" id="zoomValue">100%</span>
            </div>
        </aside>

        <section class="viewer">
            <div id="pagesContainer" class="pages-container"></div>
        </section>

        <aside class="sidebar right user-only">
            <h3>Required Fields</h3>
            <div id="statusList" class="status-list">
                <p style="color:#64748b;">No fields to fill</p>
            </div>
        </aside>
    </main>

    <!-- Signature Modal -->
    <div id="signatureModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Adopt Your Signature</h2>
                <button class="modal-close" onclick="closeSignatureModal()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="modal-body">
                <div style="display:grid; gap:1rem; margin-bottom:1.5rem;">
                    <div>
                        <label style="display:block; margin-bottom:.5rem; font-weight:500;">Full Name</label>
                        <input type="text" id="fullName" style="width:100%; padding:.5rem; border:1px solid var(--border); border-radius:6px;" placeholder="Anthony Carranza" oninput="updateNameAndInitials()" />
                    </div>
                    <div>
                        <label style="display:block; margin-bottom:.5rem; font-weight:500;">
                            Initials
                            <span style="background:var(--success); color:#fff; font-size:.75rem; padding:2px 6px; border-radius:4px; margin-left:.5rem;">Auto-detected</span>
                        </label>
                        <input type="text" id="initials" style="width:100%; padding:.5rem; border:1px solid var(--border); border-radius:6px; background:#f8fafc;" placeholder="AC" maxlength="4" />
                        <small style="color:#64748b; font-size:.75rem; margin-top:.25rem; display:block;">Automatically generated from your name. You can edit if needed.</small>
                    </div>
                </div>

                <div class="signature-tabs">
                    <button class="signature-tab active" onclick="switchTab('type')">Select Style</button>
                    <button class="signature-tab" onclick="switchTab('draw')">Draw</button>
                </div>

                <div id="typeTab" class="tab-content active">
                    <div class="signature-styles" id="signatureStyles"></div>
                </div>

                <div id="drawTab" class="tab-content">
                    <p style="color:#64748b; margin-bottom:1rem;">Draw your signature below:</p>
                    <canvas id="drawCanvas" class="drawing-canvas" width="600" height="200"></canvas>
                    <div style="margin-top:1rem;">
                        <button class="btn btn-secondary" onclick="clearCanvas()">
                            <i class="fa-solid fa-eraser"></i>
                            Clear
                        </button>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSignatureModal()">Cancel</button>
                <button class="btn btn-primary" onclick="adoptSignature()">
                    <i class="fa-solid fa-check"></i>
                    Adopt & Sign
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <!-- PDF libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

    <script>
        // Global state
        const state = {
            mode: 'admin',
            pdfDoc: null,
            pdfBytes: null,
            currentTool: null,
            fields: [],
            placements: {},
            signature: null,
            scale: 1.0,
            pageCount: 0
        };

        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Initialize
        document.getElementById('pdfInput').addEventListener('change', handleFileSelect);
        initializeDrawing();

        // --- Signature autosize helpers ---
        const __measureCanvas = document.createElement('canvas');
        const __measureCtx = __measureCanvas.getContext('2d');

        function __computeFittingFontSize(text, fontFamily, maxWidth, maxHeight) {
            const pad = 0;
            let low = 4, high = Math.max(8, Math.floor(maxHeight - pad));
            let best = 4;
            while (low <= high) {
                const mid = Math.floor((low + high) / 2);
                __measureCtx.font = `${mid}px '${fontFamily}', cursive`;
                const w = __measureCtx.measureText(text).width;
                const h = mid; // approx line height
                if (w <= (maxWidth - pad) && h <= (maxHeight - pad)) {
                    best = mid;
                    low = mid + 1;
                } else {
                    high = mid - 1;
                }
            }
            return Math.max(4, best);
        }

        function fitSignatureInField(fieldEl) {
            const node = fieldEl.querySelector('.signature-fit');
            if (!node) return;
            const fontFamily = (getComputedStyle(node).fontFamily || '').split(',')[0].replace(/["']/g, '') || 'Dancing Script';
            const text = node.textContent || '';
            const maxW = Math.max(10, fieldEl.clientWidth - 8);
            const maxH = Math.max(10, fieldEl.clientHeight - 8);
            const size = __computeFittingFontSize(text, fontFamily, maxW, maxH);
            node.style.fontSize = size + 'px';
            node.style.lineHeight = '1';
        }
        // --- end helpers ---

        // File handling
        async function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file || file.type !== 'application/pdf') return;
            const arrayBuffer = await file.arrayBuffer();
            state.pdfBytes = arrayBuffer;
            await renderPDF(arrayBuffer);
        }

        // PDF rendering
        async function renderPDF(arrayBuffer) {
            try {
                const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                state.pdfDoc = await loadingTask.promise;
                state.pageCount = state.pdfDoc.numPages;

                const container = document.getElementById('pagesContainer');
                container.innerHTML = '';

                for (let pageNum = 1; pageNum <= state.pageCount; pageNum++) {
                    const page = await state.pdfDoc.getPage(pageNum);
                    const viewport = page.getViewport({ scale: state.scale });

                    const pageWrapper = document.createElement('div');
                    pageWrapper.className = 'page-wrapper';
                    pageWrapper.dataset.page = pageNum;

                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    const context = canvas.getContext('2d');
                    await page.render({ canvasContext: context, viewport }).promise;

                    const overlay = document.createElement('div');
                    overlay.className = 'overlay';
                    overlay.dataset.page = pageNum;
                    overlay.onclick = (e) => handleOverlayClick(e, pageNum);

                    pageWrapper.appendChild(canvas);
                    pageWrapper.appendChild(overlay);
                    container.appendChild(pageWrapper);
                }

                redrawFields();
                document.getElementById('saveBtn').disabled = false;
                updateDownloadButton();
                showToast('PDF loaded successfully');
            } catch (err) {
                console.error('Error rendering PDF:', err);
                showToast('Error loading PDF', 'error');
            }
        }

        // Tools
        function selectTool(tool) {
            state.currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tool === tool);
            });
        }

        function handleOverlayClick(e, pageNum) {
            if (state.mode !== 'admin' || !state.currentTool) {
                if (state.mode === 'user') {
                    const field = getFieldAtPosition(e, pageNum);
                    if (field) fillField(field);
                }
                return;
            }
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            createField(state.currentTool, pageNum, x, y);
        }

        function createField(type, pageNum, x, y) {
            const field = {
                id: `field_${Date.now()}`,
                type, page: pageNum, x, y, width: 150, height: 50
            };
            state.fields.push(field);
            drawField(field);
            updateStatusList();
        }

        function drawField(field) {
            const overlay = document.querySelector(`.overlay[data-page="${field.page}"]`);
            if (!overlay) return;

            const existing = document.getElementById(field.id);
            if (existing) existing.remove();

            const el = document.createElement('div');
            el.className = `field ${field.type}`;
            el.id = field.id;
            el.style.left = `${field.x}px`;
            el.style.top = `${field.y}px`;
            el.style.width = `${field.width}px`;
            el.style.height = `${field.height}px`;

            if (state.placements[field.id]) {
                el.classList.add('filled');
                const placement = state.placements[field.id];

                if (placement.type === 'signature') {
                    const sig = document.createElement('div');
                    sig.className = 'signature-text signature-fit';
                    sig.style.fontFamily = `'${placement.font}', cursive`;
                    sig.style.textAlign = 'center';
                    sig.style.color = '#1a1a1a';
                    sig.style.overflow = 'hidden';
                    sig.textContent = placement.text;
                    el.appendChild(sig);
                    fitSignatureInField(el);
                } else if (placement.type === 'drawnImage') {
                    const img = document.createElement('img');
                    img.src = placement.data;
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '100%';
                    img.style.objectFit = 'contain';
                    el.appendChild(img);
                } else {
                    el.innerHTML = `<div class="field-label">${placement.data}</div>`;
                }
            } else {
                const label = document.createElement('div');
                label.className = 'field-label';
                label.textContent = field.type.charAt(0).toUpperCase() + field.type.slice(1);
                el.appendChild(label);
            }

            if (state.mode === 'admin') {
                const resize = document.createElement('div');
                resize.className = 'resize-handle';
                resize.innerHTML = `<i class="fa-solid fa-up-right-and-down-left-from-center"></i>`;
                el.appendChild(resize);

                const del = document.createElement('div');
                del.className = 'delete-btn';
                del.innerHTML = `<i class="fa-solid fa-xmark"></i>`;
                del.onclick = (ev) => { ev.stopPropagation(); deleteField(field.id); };
                el.appendChild(del);

                makeFieldDraggable(el, field);
                makeFieldResizable(el, field, resize);
            }

            overlay.appendChild(el);
        }

        function makeFieldDraggable(element, field) {
            let isDragging = false, startX, startY, initialX, initialY;

            element.addEventListener('mousedown', (e) => {
                if (e.target.closest('.resize-handle') || e.target.closest('.delete-btn')) return;
                isDragging = true;
                startX = e.clientX; startY = e.clientY;
                initialX = field.x; initialY = field.y;
                element.style.cursor = 'grabbing';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                field.x = initialX + dx;
                field.y = initialY + dy;
                element.style.left = `${field.x}px`;
                element.style.top = `${field.y}px`;
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    element.style.cursor = 'move';
                }
            });
        }

        function makeFieldResizable(element, field, handle) {
            let isResizing = false, startX, startY, initialW, initialH;

            handle.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX; startY = e.clientY;
                initialW = field.width; initialH = field.height;
                e.stopPropagation(); e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                field.width = Math.max(50, initialW + dx);
                field.height = Math.max(30, initialH + dy);
                element.style.width = `${field.width}px`;
                element.style.height = `${field.height}px`;
                if (element.querySelector('.signature-text')) {
                    fitSignatureInField(element);
                }
            });

            document.addEventListener('mouseup', () => { isResizing = false; });
        }

        function deleteField(id) {
            state.fields = state.fields.filter(f => f.id !== id);
            document.getElementById(id)?.remove();
            delete state.placements[id];
            updateStatusList();
        }

        function redrawFields(){ state.fields.forEach(drawField); }

        function getFieldAtPosition(e, pageNum) {
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            return state.fields.find(f =>
                f.page === pageNum &&
                x >= f.x && x <= f.x + f.width &&
                y >= f.y && y <= f.y + f.height
            );
        }

        // Fill (user)
        function fillField(field) {
            if (field.type === 'signature' || field.type === 'initials') {
                if (!state.signature) { showToast('Please adopt a signature first'); return; }

                if (state.signature.drawnSignature && field.type === 'signature') {
                    state.placements[field.id] = { type: 'drawnImage', data: state.signature.drawnSignature };
                } else {
                    const text = field.type === 'signature' ? state.signature.name : state.signature.initials;
                    const font = state.signature.font;
                    state.placements[field.id] = { type: 'signature', text, font };
                }
            } else if (field.type === 'date') {
                const date = new Date().toLocaleDateString();
                state.placements[field.id] = { type: 'text', data: date };
            } else if (field.type === 'text') {
                const text = prompt('Enter text:');
                if (text) state.placements[field.id] = { type: 'text', data: text };
            }

            drawField(field);
            updateStatusList();
            updateDownloadButton();
        }

        // Mode switching
        function setMode(mode) {
            state.mode = mode;
            document.body.className = `${mode}-mode`;
            document.getElementById('adminMode').classList.toggle('active', mode === 'admin');
            document.getElementById('userMode').classList.toggle('active', mode === 'user');
            document.querySelectorAll('.overlay').forEach(ov => ov.style.pointerEvents = 'auto');
            redrawFields();
            updateStatusList();
        }

        // Status list
        function updateStatusList() {
            const list = document.getElementById('statusList');
            if (state.fields.length === 0) {
                list.innerHTML = '<p style="color:#64748b;">No fields to fill</p>';
                return;
            }
            list.innerHTML = '';
            state.fields.forEach((field, i) => {
                const item = document.createElement('div');
                item.className = 'status-item';
                if (state.placements[field.id]) item.classList.add('filled');

                item.innerHTML = `
                    <div class="status-label">
                        ${i + 1}. ${field.type.charAt(0).toUpperCase() + field.type.slice(1)} (Page ${field.page})
                    </div>
                    ${state.placements[field.id]
                        ? '<i class="fa-solid fa-check status-icon"></i>'
                        : '<i class="fa-regular fa-circle" style="color: var(--border);"></i>'}
                `;
                list.appendChild(item);
            });
            updateDownloadButton();
        }

        function updateDownloadButton() {
            const allFilled = state.fields.every(f => state.placements[f.id]);
            document.getElementById('downloadBtn').disabled = !state.pdfBytes || state.fields.length === 0 || !allFilled;
        }

        // Signature Modal
        function openSignatureModal() {
            const modal = document.getElementById('signatureModal');
            modal.classList.add('active');
            const fullName = document.getElementById('fullName').value;
            if (fullName) document.getElementById('initials').value = generateInitials(fullName);
            generateSignatureStyles();
        }
        function closeSignatureModal(){ document.getElementById('signatureModal').classList.remove('active'); }

        function switchTab(tab) {
            document.querySelectorAll('.signature-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`${tab}Tab`).classList.add('active');
        }

        function generateSignatureStyles() {
            const name = document.getElementById('fullName').value || 'Anthony Carranza';
            const initials = document.getElementById('initials').value || 'AC';
            const fonts = ['Great Vibes','Pacifico','Satisfy','Dancing Script','Caveat','Allura'];
            const container = document.getElementById('signatureStyles');
            container.innerHTML = '';

            fonts.forEach((font, index) => {
                const wrap = document.createElement('div');
                wrap.className = 'signature-style';
                wrap.dataset.font = font;
                wrap.onclick = () => selectSignatureStyle(wrap);
                wrap.innerHTML = `
                    <input type="radio" name="signatureFont" ${index === 0 ? 'checked' : ''} />
                    <div style="flex:1;">
                        <div class="signature-preview" style="font-family:'${font}', cursive;">${name}</div>
                        <div style="font-family:'${font}', cursive; font-size:1.2rem; margin-top:.5rem; color:#64748b;">
                            Initials: ${initials}
                        </div>
                    </div>
                `;
                container.appendChild(wrap);
                if (index === 0) {
                    wrap.classList.add('selected');
                    const badge = document.createElement('span');
                    badge.className = 'selected-check';
                    badge.innerHTML = `<i class="fa-solid fa-check"></i>`;
                    wrap.appendChild(badge);
                }
            });
        }

        function selectSignatureStyle(el) {
            document.querySelectorAll('.signature-style').forEach(s => {
                s.classList.remove('selected');
                s.querySelector('.selected-check')?.remove();
                s.querySelector('input[type="radio"]').checked = false;
            });
            el.classList.add('selected');
            el.querySelector('input[type="radio"]').checked = true;
            const badge = document.createElement('span');
            badge.className = 'selected-check';
            badge.innerHTML = `<i class="fa-solid fa-check"></i>`;
            el.appendChild(badge);
        }

        function generateInitials(fullName) {
            if (!fullName) return '';
            const parts = fullName.trim().split(/\s+/).filter(Boolean);
            if (parts.length === 0) return '';
            if (parts.length === 1) {
                const n = parts[0];
                return n.length === 1 ? n.toUpperCase() : (n[0] + n[n.length - 1]).toUpperCase();
            }
            const particles = ['de','la','del','van','von','der','den','ter','da'];
            const sig = parts.filter(p => !particles.includes(p.toLowerCase()));
            if (sig.length >= 2) return (sig[0][0] + sig[sig.length - 1][0]).toUpperCase();
            if (sig.length === 1) {
                const n = sig[0];
                return n.length === 1 ? n.toUpperCase() : (n[0] + n[n.length - 1]).toUpperCase();
            }
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        }

        function updateNameAndInitials() {
            const fullName = document.getElementById('fullName').value;
            document.getElementById('initials').value = generateInitials(fullName);
            generateSignatureStyles();
        }
        function updateSignaturePreview(){ generateSignatureStyles(); }
        function updateInitialsPreview(){ generateSignatureStyles(); }

        // Drawing canvas
        function initializeDrawing() {
            const canvas = document.getElementById('drawCanvas');
            const ctx = canvas.getContext('2d');
            let isDrawing = false;

            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';

            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                const r = canvas.getBoundingClientRect();
                ctx.beginPath();
                ctx.moveTo(e.clientX - r.left, e.clientY - r.top);
            });
            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const r = canvas.getBoundingClientRect();
                ctx.lineTo(e.clientX - r.left, e.clientY - r.top);
                ctx.stroke();
            });
            canvas.addEventListener('mouseup', () => { isDrawing = false; });

            // Touch
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const t = e.touches[0];
                canvas.dispatchEvent(new MouseEvent('mousedown', { clientX:t.clientX, clientY:t.clientY }));
            });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const t = e.touches[0];
                canvas.dispatchEvent(new MouseEvent('mousemove', { clientX:t.clientX, clientY:t.clientY }));
            });
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                canvas.dispatchEvent(new MouseEvent('mouseup', {}));
            });
        }

        function clearCanvas() {
            const canvas = document.getElementById('drawCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Adopt signature
        async function adoptSignature() {
            const name = document.getElementById('fullName').value;
            const initials = document.getElementById('initials').value;
            if (!name || !initials) { showToast('Please enter your name and initials'); return; }

            const activeTab = document.querySelector('.signature-tab.active').textContent.toLowerCase();
            if (activeTab === 'select style') {
                const selectedFont = document.querySelector('.signature-style.selected')?.dataset.font || 'Great Vibes';
                state.signature = { name, initials, font: selectedFont };
                closeSignatureModal();
                showToast('Signature adopted successfully');
            } else if (activeTab === 'draw') {
                const canvas = document.getElementById('drawCanvas');
                const imageData = canvas.toDataURL();
                const ctx = canvas.getContext('2d');
                const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                let isEmpty = true;
                for (let i = 3; i < pixels.length; i += 4) { if (pixels[i] !== 0) { isEmpty = false; break; } }
                if (isEmpty) { showToast('Please draw your signature'); return; }
                state.signature = { name, initials, font: 'Dancing Script', drawnSignature: imageData };
                closeSignatureModal();
                showToast('Signature adopted successfully');
            }
        }

        async function textToImage(text, font, width, height) {
            const c = document.createElement('canvas');
            c.width = width; c.height = height;
            const ctx = c.getContext('2d');
            ctx.clearRect(0,0,width,height);
            ctx.font = `${height * 0.6}px '${font}', cursive`;
            ctx.fillStyle = '#000';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, width / 2, height / 2);
            return c.toDataURL();
        }

        // Template
        function saveTemplate() {
            const template = { fields: state.fields, created: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(template, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'pdf-template.json'; a.click();
            URL.revokeObjectURL(url);
            showToast('Template saved');
        }

        // Export PDF
        async function downloadPDF() {
            if (!state.pdfBytes) return;
            try {
                const pdfDoc = await PDFLib.PDFDocument.load(state.pdfBytes);
                const pages = pdfDoc.getPages();
                const helvetica = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                const timesItalic = await pdfDoc.embedFont(PDFLib.StandardFonts.TimesRomanItalic);

                for (const field of state.fields) {
                    const placement = state.placements[field.id];
                    if (!placement) continue;

                    const page = pages[field.page - 1];
                    const { width, height } = page.getSize();
                    const wrapper = document.querySelector(`.page-wrapper[data-page="${field.page}"]`);
                    const canvas = wrapper.querySelector('canvas');
                    const scaleX = width / canvas.width;
                    const scaleY = height / canvas.height;

                    const x = field.x * scaleX;
                    const y = height - (field.y + field.height) * scaleY;
                    const fieldWidth = field.width * scaleX;
                    const fieldHeight = field.height * scaleY;

                    if (placement.type === 'signature') {
                        const padding = 2;
                        const aw = Math.max(1, fieldWidth - padding * 2);
                        const ah = Math.max(1, fieldHeight - padding * 2);
                        const widthAt1 = timesItalic.widthOfTextAtSize(placement.text, 1);
                        const sizeByWidth = aw / Math.max(1, widthAt1);
                        const sizeByHeight = typeof timesItalic.sizeAtHeight === 'function' ? timesItalic.sizeAtHeight(ah) : ah;
                        const size = Math.max(1, Math.min(sizeByWidth, sizeByHeight));
                        const textW = timesItalic.widthOfTextAtSize(placement.text, size);
                        const textH = typeof timesItalic.heightAtSize === 'function' ? timesItalic.heightAtSize(size) : size;
                        const tx = x + (fieldWidth - textW) / 2;
                        const ty = y + (fieldHeight - textH) / 2;
                        page.drawText(placement.text, {
                            x: tx,
                            y: ty,
                            size,
                            font: timesItalic,
                            color: PDFLib.rgb(0.1, 0.1, 0.1)
                        });
                    } else if (placement.type === 'drawnImage') {
                        const imgData = placement.data.split(',')[1];
                        const imgBytes = Uint8Array.from(atob(imgData), c => c.charCodeAt(0));
                        const img = await pdfDoc.embedPng(imgBytes);
                        const dims = img.scale(1);
                        const s = Math.min(fieldWidth / dims.width, fieldHeight / dims.height);
                        const w = dims.width * s, h = dims.height * s;
                        page.drawImage(img, { x: x + (fieldWidth - w) / 2, y: y + (fieldHeight - h) / 2, width: w, height: h });
                    } else {
                        page.drawText(placement.data, {
                            x: x + 5, y: y + fieldHeight / 2 - 6, size: 12, font: helvetica, color: PDFLib.rgb(0,0,0)
                        });
                    }
                }

                const out = await pdfDoc.save();
                const blob = new Blob([out], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'signed-document.pdf'; a.click();
                URL.revokeObjectURL(url);
                showToast('PDF downloaded successfully');
            } catch (err) {
                console.error('Error generating PDF:', err);
                showToast('Error downloading PDF', 'error');
            }
        }

        // Demo
        async function loadDemo() {
            const { PDFDocument, StandardFonts, rgb } = PDFLib;
            const pdfDoc = await PDFDocument.create();
            const page = pdfDoc.addPage([612, 792]);
            const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const bold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

            page.drawText('SERVICE AGREEMENT', { x:50, y:720, size:24, font:bold, color:rgb(.1,.1,.3) });

            const content = [
                'This Service Agreement ("Agreement") is entered into on the date signed below',
                'between Example Corp ("Service Provider") and the undersigned ("Client").',
                '',
                'SERVICES: The Service Provider agrees to provide professional consulting services',
                'as described in the attached Statement of Work.',
                '',
                'TERM: This Agreement shall commence on the date signed and continue for a period',
                'of twelve (12) months unless terminated earlier in accordance with this Agreement.',
                '',
                'COMPENSATION: The Client agrees to pay the Service Provider a fee of $5,000 per',
                'month for the services rendered under this Agreement.',
                '',
                'CONFIDENTIALITY: Both parties agree to maintain the confidentiality of any',
                'proprietary information shared during the term of this Agreement.',
                '',
                'TERMINATION: Either party may terminate this Agreement with 30 days written notice.',
                '',
                'GOVERNING LAW: This Agreement shall be governed by the laws of the State of',
                'California, United States.',
            ];
            let y = 660;
            for (const line of content) {
                page.drawText(line, { x:50, y, size:12, font, color:rgb(0,0,0) });
                y -= 20;
            }

            page.drawText('CLIENT SIGNATURE:', { x:50, y:200, size:12, font:bold });
            page.drawLine({ start:{x:50,y:180}, end:{x:250,y:180}, thickness:1, color:rgb(0,0,0) });
            page.drawText('DATE:', { x:300, y:200, size:12, font:bold });
            page.drawLine({ start:{x:300,y:180}, end:{x:450,y:180}, thickness:1, color:rgb(0,0,0) });

            page.drawText('PROVIDER SIGNATURE:', { x:50, y:130, size:12, font:bold });
            page.drawLine({ start:{x:50,y:110}, end:{x:250,y:110}, thickness:1, color:rgb(0,0,0) });
            page.drawText('DATE:', { x:300, y:130, size:12, font:bold });
            page.drawLine({ start:{x:300,y:110}, end:{x:450,y:110}, thickness:1, color:rgb(0,0,0) });

            const pdfBytes = await pdfDoc.save();
            state.pdfBytes = pdfBytes;
            await renderPDF(pdfBytes);

            state.fields = [
                { id:'field_1', type:'signature', page:1, x:50,  y:450, width:200, height:60 },
                { id:'field_2', type:'date',      page:1, x:300, y:460, width:150, height:40 },
                { id:'field_3', type:'signature', page:1, x:50,  y:520, width:200, height:60 },
                { id:'field_4', type:'date',      page:1, x:300, y:530, width:150, height:40 }
            ];

            redrawFields();
            updateStatusList();
            showToast('Demo PDF loaded with sample fields');
        }

        // Zoom
        function setZoom(value) {
            state.scale = value / 100;
            document.getElementById('zoomValue').textContent = `${value}%`;
            if (state.pdfBytes) renderPDF(state.pdfBytes);
        }

        // Toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>